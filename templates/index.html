{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1>ğŸ¡ Property Scoring Dashboard</h1>
</div>

<div class="controls">
    <form id="filterForm" method="GET">
        <!-- Password input -->
        <div class="control-group">
            <label for="password">Password (for editing ratings):</label>
            <div class="control-row">
                <input type="text" id="password" name="password" 
                       value="{{ request.args.get('password', '') }}" 
                       placeholder="Enter password" maxlength="4">
                {% if request.args.get('password') %}
                    {% if password_correct %}
                        <span class="success">âœ… Edit access granted</span>
                    {% else %}
                        <span class="error">âŒ Incorrect password</span>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Settings Link -->
        <div class="control-group">
            <div class="settings-link-container">
                <a href="javascript:void(0)" onclick="goToSettings()" class="settings-link">
                    ğŸ”§ Adjust Scoring Weights
                </a>
                <span class="settings-hint">Customize how properties are scored and ranked</span>
            </div>
        </div>

        <!-- Financing eligibility filter -->
        <div class="control-group">
            <label>Show financing eligibility:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="filter_financing_eligible" name="financing_filter" value="eligible"
                           {% if 'eligible' in financing_filter %}checked{% endif %}
                           onchange="updateFilters()">
                    <label for="filter_financing_eligible">ğŸ’° Eligible</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter_financing_not_eligible" name="financing_filter" value="not_eligible"
                           {% if 'not_eligible' in financing_filter %}checked{% endif %}
                           onchange="updateFilters()">
                    <label for="filter_financing_not_eligible">ğŸš« Not Eligible</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter_financing_unknown" name="financing_filter" value="unknown"
                           {% if 'unknown' in financing_filter %}checked{% endif %}
                           onchange="updateFilters()">
                    <label for="filter_financing_unknown">â“ Unknown</label>
                </div>
            </div>
        </div>

        <!-- Rating filters -->
        <div class="control-group">
            <label>Show ratings:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="filter_yes" name="rating_filter" value="yes"
                           {% if 'yes' in rating_filter %}checked{% endif %}
                           onchange="updateFilters()">
                    <label for="filter_yes">âœ… Yes</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter_no" name="rating_filter" value="no"
                           {% if 'no' in rating_filter %}checked{% endif %}
                           onchange="updateFilters()">
                    <label for="filter_no">âŒ No</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter_maybe" name="rating_filter" value="maybe"
                           {% if 'maybe' in rating_filter %}checked{% endif %}
                           onchange="updateFilters()">
                    <label for="filter_maybe">ğŸ¤” Maybe</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter_blank" name="rating_filter" value="blank"
                           {% if 'blank' in rating_filter %}checked{% endif %}
                           onchange="updateFilters()">
                    <label for="filter_blank">âšª Blank</label>
                </div>
            </div>
        </div>

        <!-- Sorting removed for simplicity -->
    </form>
</div>

<div class="table-container">
    {% if properties %}
        <div class="table-scroll">
            <table>
                <thead>
                    <tr>
                        <th class="rating-column" title="Your rating for this property">
                            â“
                        </th>
                        <th class="info-column" title="View property details">
                            â„¹ï¸
                        </th>
                        <th>Location</th>
                        <th>Price</th>
                        <th>ğŸ« School</th>
                        <th>ğŸš” Crime</th>
                        <th>ğŸ›’ Grocery</th>
                        <th class="hide-very-small">Beds</th>
                        <th class="hide-very-small">Baths</th>
                        <th class="hide-mobile">Home (sqft)</th>
                        <th class="hide-mobile">Lot (acres)</th>
                        <th class="hide-mobile-kitchen">Kitchen</th>
                        <th class="hide-mobile">Bath Qual</th>
                        <th class="hide-mobile">Interior</th>
                        <th class="hide-mobile">Privacy</th>
                    </tr>
                </thead>
                <tbody>
                    {% for property in properties %}
                    <tr>
                        <td class="rating-column">
                            <select class="rating-select" 
                                    onchange="updateRating({{ property.zpid }}, this.value, document.getElementById('password').value)"
                                    {% if not password_correct %}disabled{% endif %}>
                                <option value="" {% if property.rating == '' %}selected{% endif %}>-</option>
                                <option value="yes" {% if property.rating == 'yes' %}selected{% endif %}>âœ…</option>
                                <option value="maybe" {% if property.rating == 'maybe' %}selected{% endif %}>ğŸ¤”</option>
                                <option value="no" {% if property.rating == 'no' %}selected{% endif %}>âŒ</option>
                            </select>
                        </td>
                        <td class="info-column" style="text-align: center;">
                            <span class="info-icon" onclick="showDetails({{ property.zpid }})" 
                                  style="cursor: pointer; font-size: 16px; color: #667eea;" 
                                  title="Click for property details">
                                â„¹ï¸
                            </span>
                        </td>
                        <td class="location-cell">
                            <a href="{{ property.source_url }}" target="_blank" class="listing-link">
                                {{ property.city_state or 'View Listing' }}
                            </a>
                        </td>
                        <td class="price">${{ "{:,.0f}".format(property.price) }}</td>
                        <td style="text-align: center;" title="School rating (1-10 scale)">
                            {% if property.avg_school_rating %}
                                <span style="color: {{ property.school_rating_color }}; font-weight: bold;">{{ "%.1f"|format(property.avg_school_rating) }}</span>
                            {% else %}
                                <span style="color: #999999;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; font-size: 18px;" title="Crime level: {{ property.crime_emoji or 'â“' }}">
                            {{ property.crime_emoji or 'â“' }}
                        </td>
                        <td style="text-align: center;" title="Drive time to grocery store in minutes">
                            {% if property.drive_time %}
                                <span style="color: {{ property.drive_time_color }}; font-weight: bold;">{{ property.drive_time }}min</span>
                            {% else %}
                                <span style="color: #DC143C; font-size: 16px;">ğŸš«</span>
                            {% endif %}
                        </td>
                        <td class="hide-very-small">{{ property.beds or '-' }}</td>
                        <td class="hide-very-small">{{ property.baths or '-' }}</td>
                        <td class="hide-mobile">{{ "{:,.0f}".format(property.home_size_sqft) if property.home_size_sqft else '-' }}</td>
                        <td class="hide-mobile">{{ "%.1f"|format(property.lot_size_acres) if property.lot_size_acres else '-' }}</td>
                        <td class="hide-mobile-kitchen">{{ property.kitchen_quality or '-' }}</td>
                        <td class="hide-mobile">{{ property.bathroom_quality or '-' }}</td>
                        <td class="hide-mobile">{{ property.general_interior_quality or '-' }}</td>
                        <td class="hide-mobile">{{ property.privacy_level or '-' }}</td>
                    </tr>
                    <!-- Property details row (hidden by default) -->
                    <tr id="details-{{ property.zpid }}" class="details-row" style="display: none;">
                        <td colspan="15" style="padding: 15px; background: #f8f9fa; border-left: 4px solid #667eea;">
                            <div class="property-details">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                                    <div class="show-on-very-small" style="display: none;">
                                        <h4 style="margin: 0 0 8px 0; color: #667eea;">ğŸ  Property Details</h4>
                                        <p style="margin: 0; font-size: 14px;">
                                            {{ property.beds or '?' }} beds, {{ property.baths or '?' }} baths
                                            {% if property.home_size_sqft %}<br>{{ "{:,.0f}".format(property.home_size_sqft) }} sqft{% endif %}
                                            {% if property.lot_size_acres %}<br>{{ "%.1f"|format(property.lot_size_acres) }} acres{% endif %}
                                        </p>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0 0 8px 0; color: #667eea;">ğŸ’° Financing</h4>
                                        <p style="margin: 0; font-size: 14px;">{{ property.financing_eligibility_explanation or 'No information available' }}</p>
                                    </div>
                                    {% if property.general_assessment %}
                                    <div>
                                        <h4 style="margin: 0 0 8px 0; color: #667eea;">ğŸ  General Assessment</h4>
                                        <p style="margin: 0; font-size: 14px;">{{ property.general_assessment }}</p>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <h4 style="margin: 0 0 8px 0; color: #667eea;">âœ¨ Positive Features</h4>
                                        <p style="margin: 0; font-size: 14px;">{{ property.positive_features_list or 'No special features noted' }}</p>
                                    </div>
                                    {% if property.negative_features_list %}
                                    <div>
                                        <h4 style="margin: 0 0 8px 0; color: #667eea;">âš ï¸ Negative Features</h4>
                                        <p style="margin: 0; font-size: 14px;">{{ property.negative_features_list }}</p>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <h4 style="margin: 0 0 8px 0; color: #667eea;">ğŸ›’ Grocery Store</h4>
                                        <p style="margin: 0; font-size: 14px;">
                                            {% if property.grocery_name %}
                                                {{ property.grocery_name }} - {{ property.drive_time or '?' }} min drive
                                                {% if property.grocery_rating %}
                                                    <br><small>({{ property.grocery_rating }}â˜… rating{% if property.grocery_ratings_count %} from {{ property.grocery_ratings_count }} reviews{% endif %})</small>
                                                {% endif %}
                                            {% else %}
                                                <span style="color: #DC143C;">ğŸš« No grocery information available</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0 0 8px 0; color: #667eea;">ğŸ“ Full Address</h4>
                                        <p style="margin: 0; font-size: 14px;">{{ property.full_address or 'Address not available' }}</p>
                                    </div>
                                    {% if password_correct %}
                                    <div style="grid-column: 1 / -1;">
                                        <h4 style="margin: 0 0 8px 0; color: #667eea;">ğŸ“ Personal Notes</h4>
                                        <textarea id="note-{{ property.zpid }}" 
                                                  placeholder="Add your personal notes about this property..."
                                                  style="width: 100%; min-height: 80px; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                                                  onchange="markNoteDirty({{ property.zpid }})"
                                                  oninput="markNoteDirty({{ property.zpid }})">{{ property.note or '' }}</textarea>
                                        <div id="note-status-{{ property.zpid }}" style="margin-top: 5px; font-size: 12px; color: #666; min-height: 16px;">
                                            Notes will be saved automatically when you close this section.
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div style="margin-top: 10px; text-align: right;">
                                    <button onclick="showDetails({{ property.zpid }})" 
                                            style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="padding: 15px; background: #f8f9fa; font-size: 14px; color: #666; border-top: 1px solid #dee2e6;">
            ğŸ“± <strong>Mobile tip:</strong> Swipe left/right to see more columns. Click â„¹ï¸ for property details.
            <br>
            ğŸš” <strong>Crime icons:</strong> ğŸ˜‡ Safest â†’ ğŸ˜Š Safe â†’ ğŸ˜ Average â†’ ğŸ˜° Risky â†’ ğŸ˜± Most Dangerous | â“ No Data
            <br>
            ğŸ« <strong>School ratings:</strong> <span style="color: #006400; font-weight: bold;">8.5-10</span> â†’ <span style="color: #228B22; font-weight: bold;">7.0-8.4</span> â†’ <span style="color: #000000; font-weight: bold;">5.5-6.9</span> â†’ <span style="color: #FF8C00; font-weight: bold;">4.0-5.4</span> â†’ <span style="color: #DC143C; font-weight: bold;">1.0-3.9</span> | <span style="color: #999999;">-</span> No Data
            <br>
            ğŸ›’ <strong>Grocery drive time:</strong> <span style="color: #006400; font-weight: bold;">&lt;5min</span> â†’ <span style="color: #228B22; font-weight: bold;">&lt;10min</span> â†’ <span style="color: #FFD700; font-weight: bold;">&lt;20min</span> â†’ <span style="color: #FF8C00; font-weight: bold;">&lt;40min</span> â†’ <span style="color: #DC143C; font-weight: bold;">&gt;40min</span> | <span style="color: #DC143C;">ğŸš«</span> No Data
            <br>
            Showing {{ properties|length }} properties. 
            {% if not password_correct %}Enter password above to edit ratings.{% endif %}
        </div>
    {% else %}
        <div class="no-data">
            <h3>No properties found</h3>
            <p>Try adjusting your rating filters or check your database connection.</p>
        </div>
    {% endif %}
</div>

<!-- Property details modal/expandable section would go here if needed -->
<!-- For now, keeping it simple as requested -->

<style>
.settings-link-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.settings-link {
    display: inline-block;
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.settings-link:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

.settings-hint {
    font-size: 12px;
    color: #666;
    font-style: italic;
    text-align: center;
}

@media (max-width: 768px) {
    .settings-link-container {
        align-items: stretch;
    }
    
    .settings-link {
        text-align: center;
        padding: 12px 15px;
    }
}
</style>

<script>
function goToSettings() {
    // Build URL with current weight parameters and password
    const currentParams = new URLSearchParams(window.location.search);
    const settingsParams = new URLSearchParams();
    
    // Transfer password if it exists
    const passwordValue = document.getElementById('password').value;
    if (passwordValue) {
        settingsParams.append('password', passwordValue);
    }
    
    // Transfer current weight parameters to settings URL
    {% if current_weights %}
        {% for key, value in current_weights.items() %}
        settingsParams.append('weight_{{ key }}', '{{ value }}');
        {% endfor %}
    {% endif %}
    
    // Navigate to settings
    const url = '/settings' + (settingsParams.toString() ? '?' + settingsParams.toString() : '');
    window.location.href = url;
}
</script>

{% endblock %}
